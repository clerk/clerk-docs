---
description: Learn how to create a custom MFA flow in Expo with Clerk.
---

# MFA with Expo

<Callout type="warning">
  The following flow is built assuming your Clerk app is using the default instance settings. If you have changed your instance settings, you may need to make changes to the example.
</Callout>

The examples in this guide demonstrate how to build a custom multi-factor authentication (MFA) flow in Expo with Clerk.

## Before you start

To use this example, you must configure your Clerk instance to enable email and password authentication as well as MFA:

1. Enable email and password authentication:
    1. Navigate to the Clerk Dashboard and go to **User & Authentication > [Email, Phone, and Username](https://dashboard.clerk.com/last-active?path=user-authentication/email-phone-username)** in the sidebar menu.
    1. Ensure that **Email address** is required, and **Username** is not required.
    1. Select the settings cog icon to ensure that the email address [verification method](/docs/authentication/configuration/sign-up-sign-in-options#verification-methods) is set to **Email code**.
    1. In the **Authentication strategies** section of this page, ensure **Password** is enabled.
1. Enable MFA:
    1. Navigate to your Clerk Dashboard and select your application.
    1. In the sidebar menu, select **[User & Authentication > Multi-factor](https://dashboard.clerk.com/last-active?path=user-authentication/multi-factor)**.
    1. For this example, toggle on the **Authenticator application** and **Backup codes** strategy.
1. Install the `expo-checkbox` package for the UI:
    <CodeBlockTabs type="installer" options={["npm", "yarn", "pnpm"]}>
      ```bash filename="terminal"
      npm install expo-checkbox
      ```
      ```bash filename="terminal"
      yarn add expo-checkbox
      ```
      ```bash filename="terminal"
      pnpm add expo-checkbox
      ```
    </CodeBlockTabs>

## Create an MFA component

The following example demonstrates a full MFA sign-in flow that enables users to generate QR codes which can be used with an authenticator app.

> You can render this component in a custom sign-in or sign-up flow, which you can find examples of in [the Expo custom sign-in and sign-up flow guide](/docs/references/expo/custom-auth-flows/expo-sign-up-sign-in).

<Steps>

### Create the sign-in form

In your components directory, create the MFA sign-in form.

```tsx filename="components/SignInMFAForm.tsx"
import React from "react";
import { useSignIn } from "@clerk/clerk-expo";
import { useRouter } from "expo-router";
import { Text, TextInput, TouchableOpacity, View } from "react-native";
import Checkbox from "expo-checkbox";

export default function SignInMFAForm() {
  const { signIn, setActive, isLoaded } = useSignIn();

  const [email, setEmail] = React.useState("");
  const [password, setPassword] = React.useState("");
  const [code, setCode] = React.useState("");
  const [useBackupCode, setUseBackupCode] = React.useState(false);
  const [displayTOTP, setDisplayTOTP] = React.useState(false);
  const router = useRouter();

  const handleFirstStage = () => setDisplayTOTP(true);

  const onPressTOTP = React.useCallback(async () => {
    if (!isLoaded) return;

    // Start the sign-in process
    try {
      await signIn.create({
        identifier: email,
        password,
      });

      // Attempt the TOTP or backup code verification
      const signInAttempt = await signIn.attemptSecondFactor({
        strategy: useBackupCode ? "backup_code" : "totp",
        code: code,
      });

      // If verification was completed, set the session to active
      // and redirect the user
      if (signInAttempt.status === "complete") {
        await setActive({ session: signInAttempt.createdSessionId });

        router.replace("/dashboard");
      } else {
        // If the status is not complete, check why. User may need to
        // complete further steps.
        console.log(signInAttempt);
      }
    } catch (err: any) {
      // See https://clerk.com/docs/custom-flows/error-handling
      // for more info on error handling
      console.log(err);
    }
  }, [isLoaded, email, password, code, useBackupCode]);

  if (displayTOTP) {
    return (
      <View>
        <Text>Verify your account</Text>

        <View>
          <Text>Code</Text>
          <TextInput
            value={code}
            placeholder="OTP or Backup Code"
            onChangeText={(c) => setCode(c)}
          />
        </View>
        <View>
          <Text>This code is a backup code</Text>
          <Checkbox
            value={useBackupCode}
            onValueChange={() => setUseBackupCode((prev) => !prev)}
          />
        </View>
        <TouchableOpacity onPress={onPressTOTP}>
          <Text>Verify</Text>
        </TouchableOpacity>
      </View>
    );
  }

  return (
    <View>
      <Text>Sign In</Text>
      <View>
        <TextInput
          value={email}
          placeholder="Email..."
          placeholderTextColor="#000"
          onChangeText={(email) => setEmail(email)}
        />
      </View>

      <View>
        <TextInput
          value={password}
          placeholder="Password..."
          placeholderTextColor="#000"
          onChangeText={(password) => setPassword(password)}
        />
      </View>

      <TouchableOpacity onPress={handleFirstStage}>
        <Text>Sign In</Text>
      </TouchableOpacity>
    </View>
  );
}
```

### Create a `(dashboard)` route

For this example, to let users configure MFA, create a basic dashboard. Start by creating the `(dashboard)` route group and adding the following code to the layout:

```tsx filename="app/(dashboard)/_layout.tsx"
import { Redirect, Stack } from "expo-router";
import { useAuth } from "@clerk/clerk-expo";

export default function AuthenticatedLayout() {
  const { isSignedIn } = useAuth();

  if (!isSignedIn) {
    return <Redirect href={"/sign-in"} />;
  }

  return <Stack />;
}
```

### Create an account page

Next, add a basic account page to the `(dashboard)` route group that shows users whether or not MFA is enabled, and allows them to add MFA with an authenticator app.

```tsx filename="app/(dashboard)/account.tsx"
import React from "react";
import { useUser } from "@clerk/clerk-expo";
import { Link } from "expo-router";
import { View, Text, Button, TouchableOpacity } from "react-native";

export default function ManageTOTPMfa() {
  const { isLoaded, user } = useUser();

  if (!isLoaded || !user) return null;

  const disableTOTP = async () => {
    await user.disableTOTP();
  };

  const MFAEnabled = () => {
    return (
      <View>
        <Text>TOTP via authentication app enabled - </Text>
        <Button onPress={() => disableTOTP()} title="Remove" />
      </View>
    );
  };

  const MFADisabled = () => {
    return (
      <View>
        <Text>Add TOTP via authentication app - </Text>
        <TouchableOpacity>
          <Link href="/add-mfa">
            <Text>Add</Text>
          </Link>
        </TouchableOpacity>
      </View>
    );
  };

  return (
    <>
      <Text>Current MFA Settings</Text>

      <Text>Authenticator App</Text>

      {user.totpEnabled ? <MFAEnabled /> : <MFADisabled />}

      {user.backupCodeEnabled && (
        <View>
          <Text>Backup codes</Text>
          <Button title="Regenerate" />
        </View>
      )}
    </>
  );
}
```

### Create the QR code generator

Finally, create a page that adds the functionality for generating the QR code and back up codes.

```tsx filename="app/(dashboard)/add-mfa.tsx"
import React from "react";
import { useUser } from "@clerk/clerk-expo";
import { Link } from "expo-router";
import { QrCodeSvg } from "react-native-qr-svg";
import { FlatList, Button, Text, TextInput, View } from "react-native";

import { BackupCodeResource, TOTPResource } from "@clerk/types";

type AddTotpSteps = "add" | "verify" | "backupcodes" | "success";
type DisplayFormat = "qr" | "uri";

function AddTOTPMfa({
  setStep,
}: {
  setStep: React.Dispatch<React.SetStateAction<AddTotpSteps>>;
}) {
  const [totp, setTotp] = React.useState<TOTPResource | undefined>(undefined);
  const [displayFormat, setDisplayFormat] = React.useState<DisplayFormat>("qr");
  const { user } = useUser();

  React.useEffect(() => {
    void user
      ?.createTOTP()
      .then((totp: TOTPResource) => setTotp(totp))
      .catch((error) => console.log("error", error));
  }, []);

  return (
    <View>
      <Text>Add TOTP MFA</Text>

      {totp && displayFormat === "qr" && (
        <>
          <View>
            <QrCodeSvg value={totp?.uri || ""} frameSize={200} />
          </View>
          <Button title="Use URI" onPress={() => setDisplayFormat("uri")} />
        </>
      )}

      {totp && displayFormat === "uri" && (
        <>
          <View>
            <Text>{totp.uri}</Text>
          </View>
          <Button title="Use QR Code" onPress={() => setDisplayFormat("qr")} />
        </>
      )}

      <Button title="Verify" onPress={() => setStep("verify")} />
      <Button title="Reset" onPress={() => setStep("add")} />
    </View>
  );
}

function VerifyMFA({
  setStep,
}: {
  setStep: React.Dispatch<React.SetStateAction<AddTotpSteps>>;
}) {
  const [code, setCode] = React.useState("");

  const { user } = useUser();

  const verifyTotp = async (e: any) => {
    await user
      ?.verifyTOTP({ code })
      .then(() => setStep("backupcodes"))
      .catch((error) => console.log("Error", error));
  };

  return (
    <>
      <Text>Verify MFA</Text>
      <TextInput value={code} onChangeText={(c) => setCode(c)} />
      <Button onPress={verifyTotp} title="Verify Code" />
      <Button onPress={() => setStep("add")} title="Reset" />
    </>
  );
}

function BackupCodes({
  setStep,
}: {
  setStep: React.Dispatch<React.SetStateAction<AddTotpSteps>>;
}) {
  const { user } = useUser();
  const [backupCode, setBackupCode] = React.useState<
    BackupCodeResource | undefined
  >(undefined);

  React.useEffect(() => {
    if (backupCode) {
      return;
    }

    void user
      ?.createBackupCode()
      .then((backupCode: BackupCodeResource) => setBackupCode(backupCode))
      .catch((error) => console.log("Error", error));
  }, []);

  return (
    <>
      <Text>Save Backup Codes</Text>
      {backupCode && (
        <View>
          <Text>
            Save this list of backup codes somewhere safe in case you need to
            access your account in an emergency
          </Text>

          <FlatList
            data={backupCode.codes.map((code) => ({
              key: code,
            }))}
            renderItem={({ item }) => <Text>{item.key}</Text>}
          />

          <Button title="Finish" onPress={() => setStep("success")} />
        </View>
      )}
    </>
  );
}

function Success() {
  return (
    <>
      <Text>Success</Text>
      <Text>
        You successfully added TOTP Mfa via an authentication application
      </Text>
    </>
  );
}

export default function AddMfaScreen() {
  const [step, setStep] = React.useState<AddTotpSteps>("add");

  return (
    <>
      {step === "add" && <AddTOTPMfa setStep={setStep} />}
      {step === "verify" && <VerifyMFA setStep={setStep} />}
      {step === "backupcodes" && <BackupCodes setStep={setStep} />}
      {step === "success" && <Success />}

      <Link href="/account">
        <Text>Manage MFA</Text>
      </Link>
    </>
  );
}
```

</Steps>