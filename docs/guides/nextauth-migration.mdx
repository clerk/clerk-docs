---
title: Migrating to Clerk from NextAuth.js
description: Migrating from NextAuth.js
---

<TutorialHero
  framework="next"
  beforeYouStart={[
    {
      title: "Set up a Clerk application",
      link: "https://clerk.com/docs/quickstarts/setup-clerk",
    }
  ]}
>

- Install `@clerk/nextjs`
- Set environment keys
- Wrap your Next.js app in `<ClerkProvider />`
- Setup Sign-up and Sign-in UI
- Protect your app
- Read user and session data
- User IDs as Foreign Keys
- Create a production instance
- Migrate users to a production instance
- Further support

</TutorialHero>

This guide shows how to migrate an application using NextAuth.js to use Clerk for authentication.

<Steps>

### Install `@clerk/nextjs`

Clerk's Next.js SDK gives you access to prebuilt [components](/docs/components/overview), [hooks](/docs/references/nextjs/overview#client-side-helpers), and [helpers](/docs/references/nextjs/overview) for Next.js Server Components, Route Handlers and Middleware. Install it by running the following command in your terminal:

<CodeBlockTabs type="installer" options={["npm", "yarn", "pnpm"]}>
  ```bash filename="terminal"
  npm install @clerk/nextjs
  ```

```bash filename="terminal"
yarn add @clerk/nextjs
```

```bash filename="terminal"
pnpm add @clerk/nextjs
```

</CodeBlockTabs>

### Set environment keys

Store the keys in the `.env.local` file of your Next.js application.

<InjectKeys>

```sh filename=".env.local"
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY={{pub_key}}
CLERK_SECRET_KEY={{secret}}
```

</InjectKeys>

### Wrap your Next.js app in `<ClerkProvider />`

#### Remove your NextAuth.js `<SessionProvider />`

Replace `<SessionProvider session={session}>` with `<ClerkProvider>` if you are using App Router or `<ClerkProvider {...pageProps}>` if you are using Pages Router.

```tsx filename="_app.tsx"
// With NextAuth.js

import { SessionProvider } from "next-auth/react"

export default function App({
  Component,
  pageProps: { session, ...pageProps },
}) {
  return (
    <SessionProvider session={session}>
      <Component {...pageProps} />
    </SessionProvider>
  )
}
```

#### Add `<ClerkProvider />` to your root `layout.tsx` file

<CodeBlockTabs type="installer" options={["App Router", "Pages Router"]}>

```tsx filename="app/layout.tsx"
import { ClerkProvider } from '@clerk/nextjs'
import './globals.css'
 
export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <ClerkProvider>
      <html lang="en">
        <body>{children}</body>
      </html>
    </ClerkProvider>
  )
}
```

```tsx filename="_app.tsx"
import '@/styles/globals.css'
import { ClerkProvider } from "@clerk/nextjs";
import type { AppProps } from "next/app";
function MyApp({ Component, pageProps }: AppProps) {
  return (
    <ClerkProvider {...pageProps}>
      <Component {...pageProps} />
    </ClerkProvider>
  );
}
export default MyApp;
```
</CodeBlockTabs>

### Setup sign-up and sign-in UI

#### Account Portal

Account Portal is the fastest way to authenticate your app. Clerk's Account Portal hosts the `<SignIn />`, `<SignUp />`, `<UserProfile />` and other components for your application. Read more about [Account Portal](docs/account-portal/getting-started). 

To use the Account Portal, remove the routes that mount the NextAuth.js sign-in and sign-up UI. Replace the links to those routes with the [`<SignInButton>`](/docs/components/unstyled/sign-in-button) or [`<SignUpButton>`](/docs/components/unstyled/sign-out-button) components.

#### Self-hosted UI

If you want sign-in and sign-up pages in your own application, you can use [Clerk's pre-built components](/docs/references/nextjs/custom-signup-signin-pages), or implement the UI yourself using [Clerk's hooks](/docs/custom-flows/overview).

#### Custom UI

For fully custom UI, replace the existing functionality with [appropriate custom flows](/docs/custom-flows/overview#custom-flows). With Custom flows, you leverage Clerk's React hooks `useSignIn` and `useSignUp` to build fully custom UI that handles authentication with email and password, OAuth, magic links, OTP or any other authentication option Clerk offers.

### Protect your app

#### Middleware

You will need to remove the NextAuth.js Middleware from your application, and replace it with the Clerk Middleware helper. NextAuth's middleware always rejects unauthorized requests. You may have additionally configured the Next.js middleware config to protect specific private routes. You will need to make note of this configuration so you can recreate it.

##### Remove the NextAuth.js Middleware

```tsx filename="middleware.ts"
export { default } from "next-auth/middleware"

export const config = { matcher: [/** private routes */] }
```
##### Add Clerk's `authMiddleware()`

The example below is the starting Middleware configuration. Please read the [`authMiddleware()`](docs/references/nextjs/auth-middleware) documentation to learn how to configuration your Middleware. Clerk's Middleware will, by default, run for your entire application and gives you fine-grained control over handling the authenticated state. 

```tsx filename="middleware.ts"
import { authMiddleware } from "@clerk/nextjs";
 
// This example protects all routes including api/trpc routes
// Please edit this to allow other routes to be public as needed.
// See https://clerk.com/docs/references/nextjs/auth-middleware for more information about configuring your Middleware
export default authMiddleware({});
 
export const config = {
  matcher: ["/((?!.+\\.[\\w]+$|_next).*)", "/", "/(api|trpc)(.*)"],
};
```

##### Use Clerk's control components to control access

To conditionally render UI when the user is signed in, wrap it with [`<SignedIn>`](/docs/components/control/signed-in).

To conditionally render UI when the user is NOT signed in, wrap it with [`<SignedOut>`](/docs/components/control/signed-out).

```tsx filename="app/page.tsx"
import { SignedIn, SignedOut } from "@clerk/nextjs";
 
export default function Home() {
  return (
    <div>
      <SignedOut>
        <p>This content is public. Only signed out users can see this.</p>
      </SignedOut>
      <SignedIn>
        <p>This content is private. Only signed in users can see this.</p>
      </SignedIn>
    </div>
  )
}
```

### Read user and session data

#### Server side

Replace any `getServerSession(req, res, authOptions)` with Clerk's helpers.

```tsx filename="app/page.tsx"
import { getServerSession } from "next-auth";
import { authOptions } from "@/pages/api/auth/[...nextauth]";

export default function Home() {
  const data = await getServerSession(authOptions);
  console.log(data)

  return (
    <p>Home Page</p>
  )
}
```

Use [`auth()`](/docs/references/nextjs/auth#auth) if you are using App Router or [`getAuth()`](/docs/references/nextjs/get-auth#get-auth) if you are using Pages Router to read your user data.

<CodeBlockTabs type="installer" options={["App Router", "Pages Router"]}>

```tsx failename="app/page.tsx"
import { auth, currentUser } from "@clerk/nextjs";
 
export default async function Page() {
 
  const { userId } = auth();
  console.log(userId)

  return (
    <p>Home Page</p>
  )

}
```

```tsx filename="app/page.tsx"

export async function getServerSideProps(context) {
  const session = getAuth(context.req);
	
	return { props: { ...buildClerkProps(ctx.req) } };
};
```
</CodeBlockTabs>

#### Client Side

Replace NextAuth's `useSession` with Clerk's hooks.

```tsx filename="app/page.tsx"
'use client'
import { useSession } from "next-auth/react"

export default function Home() {
  const { data: session } = useSession()
  console.log(session)

  return (
    <p>Home Page</p>
  )
}
```

Use [`useAuth()`](/docs/references/react/use-auth) if you need basic authentication information or [`useUser()`](/docs/references/react/use-user) if you need the full user object.

```tsx filename="app/page.tsx"
'use client'
import { useAuth, useUser } from "@clerk/nextjs";

export default function Home() {
  const { userId, sessionId } = useAuth();
  const { isSignedIn, user } = useUser();
  console.log(userId, sessionId, isSignedIn, user)

  return (
    <p>Home Page</p>
  )
}
```

### User IDs as Foreign Keys  

When you migrate to Clerk, you will likely need to resolve the foreign key that you used in your database. If you used the userId from NextAuth.js, you could resolve this issue with one of the two following options.

#### Use Clerk's `externalId` field

When you migrate user data from NextAuth's database to Clerk, Clerk generates new user IDs for each user. If you are using existing user IDs as foreign keys in your database (e.g. in a `user_id` column), you can save those IDs as the user's `externalId` in Clerk. This `externalId` can be included in the session token by adding the following [customization](/docs/backend-requests/making/custom-session-token). The following example will return the `externalId` if one is present, and if not will return the Clerk `userId`.

```json
{
	"userId": "{{user.external_id || user.id}}"
}
``` 

In your application, you can access this 

```tsx
import { auth } from "@clerk/nextjs";
 
export default async function Page() {
 
  const { sessionClaims: { userId } } = auth()
  console.log(userId)

  return (
    <p>Home Page</p>
  )

}
```

<Callout type="info">
You can not access the above from the client side. If you are using one of Clerk's hooks then you will need to check if `externalID` exists and if not then read the `userId`. 
</Callout>

#### Update your database

Alternatively, after the data migration, you can update all the user IDs stored in your database as a foreign key to the new Clerk user IDs.

You can read more about user IDs and user data migration in the [Migration Script README](https://github.com/clerk/migration-script?tab=readme-ov-file#handling-the-foreign-key-constraint).

### Create a production instance

Every Clerk application has a Development and a Production instance. Before you start migrating user data, you will configure production instance and migrate your users directly into that instance. The [Deploying to Production](/docs/deployments/overview#deploying-to-production) page covers creating a production instance.

You can migrate a small set of users on the development instance for testing/staging. To enable importing users to your development instance, add `IMPORT_TO_DEV_INSTANCE=true` to the `.env` for the migration script.

### Migrate User Data

This walkthrough will help you move user data from your existing database to Clerk.

To retain the user data in your database for easy querying, check out the documentation on [data synchronization with webhooks](/docs/users/sync-data).

1. Clone `github.com/clerk/migration-script`
2. Create a `.env` file in the root of the cloned repository with the `CLERK_SECRET_KEY` **of your production instance**.
3. Export all the user data from your database into a users.json file. The file should be in the following format.
```json filename="users.json"
[
  {
    "userId": "string",
    "email": "email",
    "firstName": "string (optional)",
    "lastName": "string (optional)",
    "password": "string (optional)",
    "passwordHasher": "argon2 | argon | bcrypt | md5 | pbkdf2_sha256 | pbkdf2_sha256_django | pbkdf2_sha1 | scrypt_firebase",
  }
]
```
4. If you already have an API endpoint in your NextAuth.js app that returns a list of users you could use that. Otherwise you will need to query your database to obtain the user information, or use an export function from a database management tool.
    
```sql
  SELECT id as userId, email, name FROM users
```
    
5. Edit the `.env.` file in the migration, and add your Clerk Secret Key using `CLERK_SECRET_KEY`
6. Run the script with `npm start`
7. Verify by signing in to your application secured by Clerk, and by checking the users listed in the [Users](https://dashboard.clerk.com/last-active?path=users) section of the Clerk Dashboard.
9. Check for an error log for any users that were not migrated successfully.

### Further Support

This guide covers the most common steps that you would take for the migration. If you have more complex integrations with NextAuth that are not covered here, don't hesitate to hop into the Clerk discord and open a support question.

</Steps>
