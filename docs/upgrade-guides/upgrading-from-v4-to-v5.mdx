---
title: Upgrading from v4 to v5
description: Learn how to upgrade from version 4 to version 5 of the Clerk JavaScript libraries.
---

# Upgrading from v4 to v5

On January 16, 2024, Clerk launched version 5 of its full suite of JavaScript libraries. Clerk's SDKs include React, Next.js, Remix, Gatsby, Redwood, and others. This guide helps you with uprading to the next major version of your SDK.

Version 5 ships with an improved design and UX for its built-in components, no "flash of white page" when authenticating, and a new middleware for Next.js which defaults to not protecting any routes. Along with these highly requested features some smaller DX improvements and housekeeping items made its way into the release. If you want to know everything that's new, read the [v5 announcement post](#TODO).

<Callout type="info" > 
  Version 5/v5 refers to the [`@clerk/clerk-js`](https://www.npmjs.com/package/@clerk/clerk-js) package version. However, other SDKs like `@clerk/backend` or `@clerk/clerk-expo` are versioned independently (and would upgrade from v1 to v2). To make this page easier to read for instances of general advice only v5 is mentioned. You can think of v4 as the previous major of your SDK and v5 as the current in those cases.
</Callout>

If you're curious about Clerk's approach to versioning and support, head to the [long term support](/docs/upgrade-guides/long-term-support) document. For most users we expect a smooth upgrade path as only a couple of changes will be required: [Update dependencies](#update-dependencies), [update changes across SDKs](#common), and individual items of the SDK you use.

## Handle deprecations

Before uprading, Clerk highly recommends updating your packages to the latest v4 version. Some changes required for v5 can be applied incrementally to the latest v4, which should contribute to a smoother upgrading experience.

You can use your package manager to find the possible upgrades:

<CodeBlockTabs type="installer" options={["npm", "yarn", "pnpm"]}>
  ```bash filename="terminal"
  npm outdated
  ```

  ```bash filename="terminal"
  yarn upgrade-interactive
  ```

  ```bash filename="terminal"
  pnpm upgrade -i
  ```
</CodeBlockTabs>

After updating, look out for deprecation messages in your terminal and browser console. By resolving these deprecations you'll be able to skip some breaking changes for v5.

## Update dependencies

This section explains breaking changes for peer dependencies and tooling. In order to successfully upgrade, you need to resolve these changes. Clerk's SDKs enforce these requirements through setting `peerDependencies` and `engines` keys in their `package.json`.

### Update to Node.js 18.17.0 or later

All SDKs that rely on Node.js require you to have Node.js 18.17.0 or later installed. Last year Node.js 16 entered EOL (End of life) status so it's time to bump the required version for Clerk, too. Learn how to [update and install Node.js](https://nodejs.org/en/learn/getting-started/how-to-install-nodejs).

### Update to React 18

All SDKs that rely on React require you to use React 18. You can update your project by installing the latest version of `react` and `react-dom`.

<CodeBlockTabs type="installer" options={["npm", "yarn", "pnpm"]}>
  ```bash filename="terminal"
  npm install react@latest react-dom@latest
  ```

  ```bash filename="terminal"
  yarn add install react@latest react-dom@latest
  ```

  ```bash filename="terminal"
  pnpm add install react@latest react-dom@latest
  ```
</CodeBlockTabs>

### Update to Next.js 13.0.4 or later

If you're using `@clerk/nextjs` you will need to update your Next.js project to 13.0.4 or later. Check out Next's upgrade guides:

- [Upgrading from 12 to 13](https://nextjs.org/docs/pages/building-your-application/upgrading/version-13)
- [Upgrading from 13 to 14](https://nextjs.org/docs/app/building-your-application/upgrading/version-14)

## Update SDK

This section explains breaking changes that were made across SDKs or only in individual ones. In order to successfully upgrade, you need to resolve these changes. While it's a long list, please note that we expect most users to only have to go through the [common changes](#common) and individual items of their SDK.

As of this major version Clerk also provides a `@clerk/upgrade` CLI you can use to ease the upgrade. A questionnaire will ask you a couple of questions and afterwards you'll get a list of changes you'll need to apply to your project. Navigate to your project and run it in the terminal:

```bash filename="terminal"
npx @clerk/upgrade
```

<Callout type="info" > 
  The CLI uses regular expressions to scan for patterns that match breaking changes and log relevant upgrade notices (it doesn't change your source code). As such there is no 100% guarantee that all occurrences of those breaking changes are found.
</Callout>

### Common

This section explains changes that were made **across** multiple SDKs. Depending on which SDKs you use you'll need to change these common changes in multiple places.

#### Rename `apiKey` to `secretKey`

The `CLERK_API_KEY` environment variable was renamed to `CLERK_SECRET_KEY`. Make sure to update this in all environments (e.g. dev, staging, production).

The `apiKey` parameter was renamed to `secretKey`. You are using this with `createClerkClient` for example.

You can visit your [Clerk dashboard](https://dashboard.clerk.com/last-active?path=api-keys) to copy/paste the new keys after choosing your framework.

<Accordion titles={["@clerk/backend", "@clerk/fastify", "gatsby-plugin-clerk", "@clerk/nextjs", "@clerk/remix", "@clerk/clerk-sdk-node"]} heading="h5">
  <AccordionPanel>
    To learn more about the new `createClerkClient` import, read the dedicated [`@clerk/backend`](#clerk-backend) section.

    ```diff
    - import { Clerk } from "@clerk/backend"
    + import { createClerkClient } from "@clerk/backend"

    - const clerkClient = Clerk({ apiKey: "" })
    + const clerkClient = createClerkClient({ secretKey: "" })
    ```
  </AccordionPanel>

  <AccordionPanel>
    ```diff
    - createClerkClient({ apiKey: "" })
    + createClerkClient({ secretKey: "" })
    ```
  </AccordionPanel>

  <AccordionPanel>
    ```diff
    - createClerkClient({ apiKey: "" })
    + createClerkClient({ secretKey: "" })
    ```
  </AccordionPanel>

  <AccordionPanel>
    To learn more about the new `clerkMiddleware` helper, read the dedicated [`@clerk/nextjs`](#clerk-nextjs) section.

    ```diff
    - import { authMiddleware } from "@clerk/nextjs"
    + import { clerkMiddleware } from "@clerk/nextjs/server"

    - export default authMiddleware({ apiKey: "" })
    + export default clerkMiddleware({ secretKey: "" })
    ```

    ```diff
    - createClerkClient({ apiKey: "" })
    + createClerkClient({ secretKey: "" })
    ```

    ```diff
    - getAuth(args, { apiKey: "" })
    + getAuth(args, { secretKey: "" })
    ```
  </AccordionPanel>

  <AccordionPanel>
    ```diff
    - rootAuthLoader(args, { apiKey: "" })
    + rootAuthLoader(args, { secretKey: "" })
    ```

    ```diff
    - createClerkClient({ apiKey: "" })
    + createClerkClient({ secretKey: "" })
    ```

    ```diff
    - getAuth(args, { apiKey: "" })
    + getAuth(args, { secretKey: "" })
    ```
  </AccordionPanel>

  <AccordionPanel>
    ```diff
    - createClerkClient({ apiKey: "" })
    + createClerkClient({ secretKey: "" })
    ```

    ```diff
    - createClerkExpressRequireAuth({ apiKey: "" })
    + createClerkExpressRequireAuth({ secretKey: "" })
    ```

    ```diff
    - createClerkExpressWithAuth({ apiKey: "" })
    + createClerkExpressWithAuth({ secretKey: "" })
    ```

    ```diff
    - const clerkClient = createClerkClient({ apiKey: "" })
    - setClerkApiKey("")
    + const clerkClient = createClerkClient({ secretKey: "" })
    ```
  </AccordionPanel>
</Accordion>

#### Replace `frontendApi` with `publishableKey`

The `CLERK_FRONTEND_API` environment variable was removed. Use `CLERK_PUBLISHABLE_KEY` on your frontend instead. Make sure to update this in all environments (e.g. dev, staging, production).

The `frontendApi` prop passed to `<ClerkProvider>` was removed and you should use `publishableKey`. The function parameter was also renamed (you are using this with `createClerkClient` for example).

<Callout type="warning" > 
  The values are different, so this is not just a key replacement. You can visit your [Clerk dashboard](https://dashboard.clerk.com/last-active?path=api-keys) to copy/paste the new keys after choosing your framework.
</Callout>

<Accordion titles={["@clerk/backend", "@clerk/clerk-js", "@clerk/clerk-expo", "@clerk/fastify", "gatsby-plugin-clerk", "@clerk/nextjs", "@clerk/clerk-react", "@clerk/remix", "@clerk/clerk-sdk-node"]} heading="h5">
  <AccordionPanel>
    To learn more about the new `createClerkClient` import, read the dedicated [`@clerk/backend`](#clerk-backend) section.

    ```diff
    - import { Clerk } from "@clerk/backend"
    + import { createClerkClient } from "@clerk/backend"

    - const clerkClient = Clerk({ frontendApi: "" })
    + const clerkClient = createClerkClient({ publishableKey: "" })
    ```
  </AccordionPanel>

  <AccordionPanel>
    ```diff
    - const clerkFrontendApi = "pk_[frontend_api]"
    + const clerkPublishableKey = "pk_[publishable_key]"

    - const clerk = new Clerk(clerkFrontendApi)
    + const clerk = new Clerk(clerkPublishableKey)
    ```

    ```diff
    - const clerkFrontendApi = "pk_[frontend_api]"
    + const clerkPublishableKey = "pk_[publishable_key]"

    const script = document.createElement("script")
    - script.setAttribute("data-clerk-frontend-api", clerkFrontendApi)
    + script.setAttribute("data-clerk-publishable-key", clerkPublishableKey)
    ```
  </AccordionPanel>

  <AccordionPanel>
    ```diff
    - <ClerkProvider frontendApi="">
    + <ClerkProvider publishableKey="">
    ```
  </AccordionPanel>

  <AccordionPanel>
    ```diff
    - createClerkClient({ frontendApi: "" })
    + createClerkClient({ publishableKey: "" })
    ```

    ```diff
    - fastify.register(clerkPlugin, { frontendApi: "" })
    + fastify.register(clerkPlugin, { publishableKey: "" })
    ```
  </AccordionPanel>

  <AccordionPanel>
    ```diff
    - createClerkClient({ frontendApi: "" })
    + createClerkClient({ publishableKey: "" })
    ```
  </AccordionPanel>

  <AccordionPanel>
    ```diff
    - <ClerkProvider frontendApi="">
    + <ClerkProvider publishableKey="">
    ```

    To learn more about the new `clerkMiddleware` helper, read the dedicated [`@clerk/nextjs`](#clerk-nextjs) section.

    ```diff
    - import { authMiddleware } from "@clerk/nextjs"
    + import { clerkMiddleware } from "@clerk/nextjs/server"

    - export default authMiddleware({ frontendApi: "" })
    + export default clerkMiddleware({ publishableKey: "" })
    ```
  </AccordionPanel>

  <AccordionPanel>
    ```diff
    - <ClerkProvider frontendApi="">
    + <ClerkProvider publishableKey="">
    ```
  </AccordionPanel>

  <AccordionPanel>
    ```diff
    - <ClerkProvider frontendApi="">
    + <ClerkProvider publishableKey="">
    ```

    ```diff
    - rootAuthLoader(args, { frontendApi: "" })
    + rootAuthLoader(args, { publishableKey: "" })
    ```
  </AccordionPanel>

  <AccordionPanel>
    ```diff
    - createClerkClient({ frontendApi: "" })
    + createClerkClient({ publishableKey: "" })
    ```

    ```diff
    - createClerkExpressRequireAuth({ frontendApi: "" })
    + createClerkExpressRequireAuth({ publishableKey: "" })
    ```

    ```diff
    - createClerkExpressWithAuth({ frontendApi: "" })
    + createClerkExpressWithAuth({ publishableKey: "" })
    ```
  </AccordionPanel>
</Accordion>

#### Rename magic link to email link

Across Clerk's documentation and codebases the term "magic link" was changed to "email link" as it more accurately reflects the functionality.

Inside your code, change the following values:

- `handleMagicLinkVerification` => `handleEmailLinkVerification`
- `isMagicLinkError` => `isEmailLinkError`
- `MagicLinkError` => `EmailLinkError`
- `MagicLinkErrorCode` => `EmailLinkErrorCode`
- `useMagicLink` => `useEmailLink`
- `createMagicLinkFlow()` => `createEmailLinkFlow()`

Functionality stayed the same and only the name changed.

#### Replace `navigate` with `routerPush` & `routerReplace`

The `navigate` prop on `<ClerkProvider>` allowed developers to override the default navigation behavior with a custom function. However, `navigate` was only able to push, not replace routes. The router is now able to do both, and as such, the props for `<ClerkProvider>` were updated. The `routerPush` and `routerReplace` props replace the old `navigate` prop.

For more information on what push and replace mean in relation to the browser history api, check out the ["Working with the History API"](https://developer.mozilla.org/en-US/docs/Web/API/History_API/Working_with_the_History_API) docs.

If you’d like to keep the same behavior as you had with the single `navigate` prop, pass the exact same function to both `routerPush` and `routerReplace`. For example:

```diff
- <ClerkProvider navigate={x => x} />
+ <ClerkProvider routerPush={x => x} routerReplace={x => x} />
```

#### Replace `setSession` with `setActive`

`setSession()` should be replaced with [`setActive()`](/docs/references/javascript/clerk/session-methods#set-active). The format of the parameters has changed slightly - `setActive` takes an object where `setSession` took params directly. The `setActive` function also can accept an `organization` param that is used to set the currently active organization. The return signature did not change. Read the [API documentation](/docs/references/javascript/clerk/session-methods#set-active) for more detail.

This function should be expected to be returned from one of the following Clerk hooks: `useSessionList`, `useSignUp`, or `useSignIn`. Some migration examples:

```diff
import { useSignIn } from "@clerk/nextjs"
 
export default function SignIn() { 
  const { setActive } = useSignIn()

- await setSession("sessionID", () => void)
+ await setActive({ session: "sessionID",  beforeEmit: () => void })

- await setSession(sessionObj)
+ await setActive({ session: sessionObj })

- await setSession(sessionObj, () => void)
+ await setActive({ session: sessionObj,  beforeEmit: () => void })
}
```

`setActive` also supports setting an active organization:

```js
await setActive({
  session: 'sessionID',
  organization: 'orgID',
  beforeEmit: () => void 
})
await setActive({
  session: sessionObj,
  organization: orgObj,
  beforeEmit: () => void
})
```

Or as part of the `Clerk` class of `@clerk/clerk-js`:

```js
import Clerk from "@clerk/clerk-js"
 
const clerkPublishableKey = ​your_publishable_key​
const clerk = new Clerk(clerkPublishableKey)
await clerk.load()

await clerk.setActive({ session: "" })
```

#### `API_URL` value has changed

The `API_URL` export has changed from `https://api.clerk.dev` to `https://api.clerk.com`.

#### Removed the `orgs` claim as a default property of the JWT

In v4 of Clerk's SDKs, if you decode the session token that Clerk returns from the server, you'll currently find an `orgs` claim on it. It lists all the orgs associated with the given user. In v5 Clerk returns the `org_id`, `org_slug`, and `org_role` of the **active** organization.

If you would like to have your JWT return all of the user's organizations, you can create a [custom JWT template](/docs/backend-requests/making/jwt-templates) in your dashboard. Add `{ "orgs": "user.organizations" }` to it.

### `@clerk/backend`

<Callout type="warning" > 
  Please take extra care in reading the instructions for the new response payload.
</Callout>

- The top level `Clerk` import was renamed to `createClerkClient`. It's a name change and functionality stayed the same.

    ```diff
    - import { Clerk } from "@clerk/backend"
    + import { createClerkClient } from "@clerk/backend"
    ```

- [Rename `apiKey` to `secretKey`](#rename-api-key-to-secret-key)
- [Replace `frontendApi` with `publishableKey`](#replace-frontend-api-with-publishable-key)
- The response payload of **every** backend API request was changed. Instead of returning the data on success and throwing an error on failure, you'll receive this object:

    ```ts
    type ClerkBackendApiResponse<T> =
      | {
          data: T;
          errors: null;
          totalCount?: number;
        }
      | {
          data: null;
          errors: Array<ClerkAPIError>;
          totalCount?: never;
          clerkTraceId?: string;
          status?: number;
          statusText?: string;
        };
    ```

    So on most requests you'll get back `{ data, errors }`. For requests that contain pagination information or where `data` is an array, you'll also receive `totalCount`. If an error happens, you'll get `errors` and in most cases also `clerkTraceId`, `status`, and `statusText`.

    <Callout type="warning" > 
      You'll need to throw errors yourself as the `@clerk/backend` functions are not handling this for you anymore. See the examples below on how to do that. 
    </Callout>

    The new API looks like this:

    ```ts
    // Single
    const { data, errors } = await clerkClient.users.getUser("")

    // Paginated response
    const {
      data,
      errors,
      totalCount
    } = await clerkClient.organizations.getOrganizationList()
    ```

    If you want to keep the old behavior, you can migrate your code to something like this:

    ```ts
    import { createClerkClient } from "@clerk/backend"
    import { ClerkAPIResponseError } from "@clerk/shared/error"

    const clerkClient = createClerkClient({ secretKey: "" })

    const { 
      data,
      errors,
      status,
      statusText
    } = await clerkClient.users.getUser("")

    if (errors) {
      throw new ClerkAPIResponseError(statusText, { data: errors, status })
    }
    ```

    Here's the changed response shape in a before and after:

    ```diff
    - const data = await clerkClient.users.getUser("")
    + const { data } = await clerkClient.users.getUser("")

    - const data = await clerkClient.organizations.getOrganizationList()
    - const totalCount = data.length
    + const {
    +  data,
    +  totalCount
    + } = await clerkClient.organizations.getOrganizationList()
    ```

- `clockSkewInSeconds` was renamed to `clockSkewInMs` but the default value stayed the same.
- Replace `getPendingOrganizationInvitationList` with `getOrganizationInvitationList` and pass a `status` parameter.

    ```diff
    - getPendingOrganizationInvitationList({ ...params })
    + getOrganizationInvitationList({ ...params, status: "pending" })
    ```

- You need to pass a `Request` to the first argument of the `authenticateRequest()` method.

    ```diff
    - const state = await clerkClient.authenticateRequest({
    + const state = await clerkClient.authenticateRequest(req, {
        secretKey: "",
        publishableKey: "",
    -   origin: req.headers.get("origin"),
    -   host: req.headers.get("host"),
    -   // ...etc
      })
    ```
- The `createEmail()` method (and as such the `emails` API endpoint) has been removed. For the time being no alternative method will be provided for creating and sending emails directly from Clerk's JavaScript SDKs. If you're currently relying on this functionality and wish to update, please reach out to [Clerk's support](/support).

Some more niche use cases and their changes:

<Accordion titles={["Removal of httpOptions", "Removal of pkgVersion", "Removal of createIsomorphicRequest & buildRequestUrl", "Use .imageUrl for image related responses/resources"]} heading="h4">
  <AccordionPanel>
    The `httpOptions` parameter was removed from the `buildRequest` function. Provide this information on the returned `request` function instead.

    ```diff
    - const r = buildRequest({ httpsOptions: { headers: {} }})
    + const request = buildRequest()
    + request({ headerParams: {} })
    ```
  </AccordionPanel>

  <AccordionPanel>
    The `pkgVersion` parameter was removed from the `loadInterstitialFromLocal`, `loadInterstitialFromBAPI`, and `buildPublicInterstitialUrl` functions. Use `clerkJSVersion` instead. Example:

    ```diff
    - loadInterstitialFromLocal({ pkgVersion: "" })
    + loadInterstitialFromLocal({ clerkJSVersion: "" })
    ```   
  </AccordionPanel>

  <AccordionPanel>
    This change is only relevant to power users of Clerk building custom integrations for frameworks that run both on the client and server (e.g. Next.js, Astro, etc.). `createIsomorphicRequest` & `buildRequestUrl` were used to adapt and transform any framework-specific request-like objects to the native `Request` class that `@clerk/backend` uses. This was done through polyfilling `fetch`. Since v5 requires you to use Node 18.17.0 or later that polyfilling is not required anymore and you can use the native `fetch`.

    If your integration needs to transform its specific object to a `Request`, you can build something like the [Fastify integration](https://github.com/clerk/javascript/blob/0cfd8cf3f1bef0a8f34b7a4d2d782dd8fc2a7090/packages/fastify/src/utils.ts) is doing.
  </AccordionPanel>

  <AccordionPanel>
    You could do a request like the following:

    ```ts
    import { createClerkClient } from "@clerk/backend"

    const clerkClient = createClerkClient({ secretKey: "" })

    const { data: user } = await clerkClient.users.getUser("")
    ```

    Previously, you could access `user.profileImageUrl` and now it's `user.imageUrl`. Various image related properties were all aligned to `imageUrl`. So if you use any of these, change the property:

    - `ExternalAccount.picture`
    - `ExternalAccountJSON.avatar_url`
    - `Organization.logoUrl`
    - `OrganizationJSON.logo_url`
    - `User.profileImageUrl`
    - `UserJSON.profile_image_url`
    - `OrganizationMembershipPublicUserData.profileImageUrl`
    - `OrganizationMembershipPublicUserDataJSON.profile_image_url`
  </AccordionPanel>
</Accordion>

### `@clerk/chrome-extension`

The `tokenCache` prop on `<ClerkProvider>` was renamed to `storageCache`.

```diff
- <ClerkProvider tokenCache={}>
+ <ClerkProvider storageCache={}>
```

The `storageCache` interface has been expanded to allow more flexibility:

```ts
type StorageCache = {
  createKey: (...keys: string[]) => string;
  get: <T = any>(key: string) => Promise<T>;
  remove: (key: string) => Promise<void>;
  set: (key: string, value: string) => Promise<void>;
}
```

### `@clerk/clerk-js`

<Callout type="warning" > 
  Please take extra care in reading the instructions for the modified shape of paginated responses and new pagination parameters.
</Callout>

- [Replace `frontendApi` with `publishableKey`](#replace-frontend-api-with-publishable-key)
- [Rename magic link to email link](#rename-magic-link-to-email-link)
- [Replace `setSession` with `setActive`](#replace-set-session-with-set-active)
- [Removed the `orgs` claim as a default property of the JWT](#removed-the-orgs-claim-as-a-default-property-of-the-jwt)
- TODO: ClerkPaginatedResponse
- TODO: Pagination Params Signature
- The [`User.update()`](/docs/references/javascript/user/user#update) method no longer accepts `password` as a parameter. If you'd like to update a users's password, please use [`User.updatePassword()`](/docs/references/javascript/user/password-management#update-password) instead.

    ```diff
    - User.update({ password: "new" })
    + User.updatePassword({ newPassword: "new" })
    ```

- The `getOrganizationMemberships()` method on the `Clerk` class has been removed. Use `getOrganizationMemberships()` on a `user` instance instead.

    ```diff
      const clerk = new Clerk()
    - clerk.getOrganizationMemberships()
    + clerk.user.getOrganizationMemberships()
    ```

    Also note that the response has changed from `Array<Organization>` to `{ total_count: number; data: Array<Organization> }`.

- The `lastOrganizationInvitation` and `lastOrganizationMember` events for [`Clerk.addListener()`](/docs/references/javascript/clerk/clerk#add-listener) have been removed. They were only relevant for internal usage and at the moment Clerk is not providing a way to achieve this functionality in another way. If you're currently relying on this functionality and wish to update, please reach out to [Clerk's support](/support).
- `Organization.create()` has a new function signature.

    ```diff
    const clerk = new Clerk()

    - clerk.organization.create("example")
    + clerk.organization.crete({ name: "example" })
    ```

- Removed `Organization.getPendingInvitations()`, you need to use `Organization.getInvitations()` instead.

    ```diff
      const clerk = new Clerk()

    - clerk.organization.getPendingInvitations()
    + clerk.organization.getInvitations({ status: "pending" })
    ```

- In [`User.createExternalAccount()`](/docs/references/javascript/user/create-metadata#create-external-account) the `redirect_url` parameter was renamed to `redirectUrl`.
- In `Signup.attemptWeb3WalletVerification()` the parameters have changed. Use `signature` instead of `identifier`.

    ```diff
      const clerk = new Clerk()

    - clerk.client.signUp.attemptWeb3WalletVerification({ identifier: "" })
    + clerk.client.signUp.attemptWeb3WalletVerification({ signature: "" })
    ```

- The default values of `afterSignOutUrl`, `afterSignIn`, and `afterSignUp` have been changed to `/`. The URLs defined in your **Dashboard > Account Portal > Redirects** won't affect these anymore. Read the [Customizing your Account Portal redirects](/docs/account-portal/custom-redirects) to learn how to override these defaults.
- The `Clerk.redirectToHome()` method has been removed. You can use `Clerk.redirectToAfterSignUp()` or `Clerk.redirectAfterSignIn()` instead.
- The `Clerk.isReady()` method has been removed. You can use the `Clerk.loaded` property instead.

    ```diff
      const clerk = new Clerk()
    - clerk.isReady()
    + clerk.loaded
    ```

Some more niche use cases and their changes:

<Accordion titles={["Removal of unstable/experimental properties", "Appearance", "Use .imageUrl for image related responses/resources"]} heading="h4">
  <AccordionPanel>
    Removed the following properties:
    
    - `Clerk.experimental_canUseCaptcha`
    - `Clerk.experimental_captchaSiteKey`
    - `Clerk.experimental_captchaURL`
    - `Clerk.__unstable__invitationUpdate`
    - `Clerk.__unstable__membershipUpdate`
    
    There is no replacement for these experimental properties.
  </AccordionPanel>
  <AccordionPanel>
    These appearance props have changed:

    - `appearence.elements.organizationPreview__organizationSwitcher` => `appearence.elements.organizationPreview__organizationSwitcherTrigger`
  </AccordionPanel>
  <AccordionPanel>
    Some image related properties have changed on class objects. See the full list below. As an example, here's how the user's profile image property changed:

    ```diff
      const clerk = new Clerk()
    - clerk.user.profileImageUrl
    + clerk.user.imageUrl
    ```

    Various image related properties were all aligned to `imageUrl`. So if you use any of these, change the property:

    - `ExternalAccount.avatarUrl`
    - `Organization.logoUrl`
    - `User.profileImageUrl`
    - `OrganizationMembershipPublicUserData.profileImageUrl`
  </AccordionPanel>
</Accordion>

### `@clerk/clerk-expo`

- [Replace `frontendApi` with `publishableKey`](#replace-frontend-api-with-publishable-key)
- [Rename magic link to email link](#rename-magic-link-to-email-link)
- [Replace `navigate` with `routerPush` & `routerReplace`](#replace-navigate-with-router-push-router-replace)
- [Replace `setSession` with `setActive`](#replace-set-session-with-set-active)

### `@clerk/fastify`

- [Rename `apiKey` to `secretKey`](#rename-api-key-to-secret-key)
- [Replace `frontendApi` with `publishableKey`](#replace-frontend-api-with-publishable-key)

### `gatsby-plugin-clerk`

- [Rename `apiKey` to `secretKey`](#rename-api-key-to-secret-key)
- [Replace `frontendApi` with `publishableKey`](#replace-frontend-api-with-publishable-key)
- [Rename magic link to email link](#rename-magic-link-to-email-link)
- [Replace `navigate` with `routerPush` & `routerReplace`](#replace-navigate-with-router-push-router-replace)
- The return type and shape of `withServerAuth` was changed from `ServerSideAuth` to `AuthObject`. `props.auth` now returns different values:

    ```ts
    type V4 = {
      sessionId: string | null;
      userId: string | null;
      actor: ActJWTClaim | null;
      getToken: ServerGetToken;
      claims: ClerkJWTClaims | null;
    }

    type V5 = {
      sessionClaims: JwtPayload;
      sessionId: string;
      actor: ActClaim | undefined;
      userId: string;
      orgId: string | undefined;
      orgRole: OrganizationCustomRoleKey | undefined;
      orgSlug: string | undefined;
      orgPermissions: Array<OrganizationCustomPermissionKey> | undefined;
      getToken: ServerGetToken;
      has: CheckAuthorizationWithCustomPermissions;
      debug: AuthObjectDebug;
    }
    ```

- Changes to top-level imports in [`@clerk/clerk-react`](#clerk-clerk-react) will also affect `gatsby-plugin-clerk` as it just re-exports those.

### `@clerk/localizations`

TODO

### `@clerk/nextjs`

- [Rename `apiKey` to `secretKey`](#rename-api-key-to-secret-key)
- [Replace `frontendApi` with `publishableKey`](#replace-frontend-api-with-publishable-key)
- The named import `MultiSessionAppSupport` was moved from `@clerk/nextjs` to `@clerk/nextjs/internal`
- `withClerkMiddleware` has been deprecated in v4 and is now removed in v5. Use [`clerkMiddleware`](/docs/references/nextjs/clerk-middleware) instead. Here's an example of having all routes public except for everything under `/dashboard`.

    Before:

    ```ts filename="middleware.ts"
    import { withClerkMiddleware } from "@clerk/nextjs/server";
    import { getAuth } from "@clerk/nextjs/server";
    import { NextResponse } from "next/server";
    import type { NextRequest } from "next/server";

    const publicPaths = ["/", "/sign-in*", "/sign-up*"];
    
    const isPublic = (path: string) => {
      return publicPaths.find((x) =>
        path.match(new RegExp(`^${x}$`.replace("*$", "($|/)")))
      );
    };
    
    export default withClerkMiddleware((request: NextRequest) => {
      if (isPublic(request.nextUrl.pathname)) {
        return NextResponse.next();
      }
      const { userId } = getAuth(request);
    
      if (!userId) { 
        const signInUrl = new URL("/sign-in", request.url);
        return NextResponse.redirect(signInUrl);
      }
      return NextResponse.next();
    });
    
    export const config = {
      matcher: ["/((?!.+\\.[\\w]+$|_next).*)", "/", "/(api|trpc)(.*)"],
    }
    ```

    After:

    ```ts filename="middleware.ts"
    import { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server';
    import { NextResponse } from 'next/server';

    const isProtectedRoute = createRouteMatcher(['/dashboard(.*)']);

    export default clerkMiddleware((auth, request) => {
      if (isProtectedRoute(request)) {
        auth().protect()
      }

      return NextResponse.next();
    });

    export const config = {
      matcher: ["/((?!.+\\.[\\w]+$|_next).*)", "/", "/(api|trpc)(.*)"],
    };
    ```

A couple of subpath imports have been removed. You should use `@clerk/nextjs` instead as the functionality stayed the same. In the case of the removed `@clerk/nextjs/api` subpath you can use `@clerk/clerk-sdk-node` instead.

<Accordion titles={["@clerk/nextjs/app-beta", "@clerk/nextjs/ssr", "@clerk/nextjs/edge-middleware", "@clerk/nextjs/edge-middlewarefiles", "@clerk/nextjs/api"]} heading="h4">
  <AccordionPanel>
    The `@clerk/nextjs` import will work with both the app and pages router.

    ```diff
    - import { } from "@clerk/nextjs/app-beta"
    + import { } from "@clerk/nextjs"
    ```
  </AccordionPanel>
  <AccordionPanel>
    The top-level imports support SSR by default now.

    ```diff
    - import { } from "@clerk/nextjs/ssr"
    + import { } from "@clerk/nextjs"
    ```
  </AccordionPanel>
  <AccordionPanel>
    ```diff
    - import { } from "@clerk/nextjs/edge-middleware"
    + import { } from "@clerk/nextjs"
    ```
  </AccordionPanel>
  <AccordionPanel>
    ```diff
    - import { } from "@clerk/nextjs/edge-middlewarefiles"
    + import { } from "@clerk/nextjs"
    ```
  </AccordionPanel>
  <AccordionPanel>
    The `@clerk/nextjs/api` subpath was removed completely. It re-exported helpers from `@clerk/clerk-sdk-node` and its types. If you relied on these, import from `@clerk/clerk-sdk-node` directly instead.

    ```diff
      import type {
        ClerkMiddleware,
        ClerkMiddlewareOptions,
        LooseAuthProp,
        RequireAuthProp,
        StrictAuthProp,
        WithAuthProp
    - } from "@clerk/nextjs/api"
    + } from "@clerk/clerk-sdk-node"

    - import { requireAuth, withAuth } from "@clerk/nextjs/api"
    + import { requireAuth, withAuth } from "@clerk/clerk-sdk-node"
    ```
  </AccordionPanel>
</Accordion>

In recent versions Next.js enforced the convention that public environment variables should be prefixed with `NEXT_PUBLIC_`. This also applies to Clerk's environment variables. Please apply these changes:

<Accordion titles={["NEXT_PUBLIC_", "Renamed environment variables"]} heading="h4">
  <AccordionPanel>

  - `CLERK_JS_VERSION` => `NEXT_PUBLIC_CLERK_JS_VERSION`

  </AccordionPanel>

  <AccordionPanel>

  - `NEXT_PUBLIC_CLERK_JS` => `NEXT_PUBLIC_CLERK_JS_URL`

  </AccordionPanel>
</Accordion>

A couple of exported constants have been removed from `@clerk/nextjs` as you should use your defined environment variables instead.

<Accordion titles={["Removed constants"]} heading="h4">
  <AccordionPanel>
  Let's say you imported `API_URL` from `@clerk/nextjs`:

  ```ts
  import { API_URL } from "@clerk/nextjs"
  ```

  If you want to use it, set it in your environment variables as `CLERK_API_URL` and access it this way. Here's the whole changelog of converting the constants to environment variables:

  - `API_URL` => `CLERK_API_URL`
  - `API_VERSION` => `CLERK_API_VERSION`
  - `CLERK_JS_URL` => `NEXT_PUBLIC_CLERK_JS_URL`
  - `CLERK_JS_VERSION` => `NEXT_PUBLIC_CLERK_JS_VERSION`
  - `DOMAIN` => `NEXT_PUBLIC_CLERK_DOMAIN`
  - `IS_SATELLITE` => `NEXT_PUBLIC_CLERK_IS_SATELLITE`
  - `PROXY_URL` => `NEXT_PUBLIC_CLERK_PROXY_URL`
  - `PUBLISHABLE_KEY` => `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`
  - `SECRET_KEY` => `CLERK_SECRET_KEY`
  - `SIGN_IN_URL` => `NEXT_PUBLIC_CLERK_SIGN_IN_URL`
  - `SIGN_UP_URL` => `NEXT_PUBLIC_CLERK_SIGN_UP_URL`

  </AccordionPanel>
</Accordion>

**Deprecated:**

- [`authMiddleware`](/docs/references/nextjs/auth-middleware). We highly recommend using [`clerkMiddleware`](/docs/references/nextjs/clerk-middleware) going forward. `clerkMiddleware` protects no routes by default and you need to add your individual routes you want to opt into protection. Here's an example of having all routes public except for everything under `/dashboard`.

    Before:

    ```ts filename="middleware.ts"
    import { authMiddleware } from "@clerk/nextjs";
    
    export default authMiddleware({
      publicRoutes: (req) => !req.url.includes("/dashboard"),
    });
    
    export const config = {
      matcher: ["/((?!.+\\.[\\w]+$|_next).*)", "/", "/(api|trpc)(.*)"],
    };
    ```

    After:

    ```ts filename="middleware.ts"
    import { clerkMiddleware, createRouteMatcher } from '@clerk/nextjs/server';
    import { NextResponse } from 'next/server';

    const isProtectedRoute = createRouteMatcher(['/dashboard(.*)']);

    export default clerkMiddleware((auth, request) => {
      if (isProtectedRoute(request)) {
        auth().protect()
      }

      return NextResponse.next();
    });

    export const config = {
      matcher: ["/((?!.+\\.[\\w]+$|_next).*)", "/", "/(api|trpc)(.*)"],
    };
    ```

### `@clerk/clerk-react`

- [Replace `frontendApi` with `publishableKey`](#replace-frontend-api-with-publishable-key)
- [Rename magic link to email link](#rename-magic-link-to-email-link)
- [Replace `navigate` with `routerPush` & `routerReplace`](#replace-navigate-with-router-push-router-replace)
- [Replace `setSession` with `setActive`](#replace-set-session-with-set-active)
- The `useOrganizations` hook was removed. Use [`useOrganizationList`](/docs/references/react/use-organization-list) instead. Please note that the latter has different function signatures.
- The `userProfile` prop on the [`UserButton`](/docs/references/javascript/clerk/user-button) component has been changed to `userProfileProps`. This is purely a name change, none of the values need to be updated.
- The `afterSwitchOrganizationUrl` prop on the `<OrganizationSwitcher />` component has been renamed to `afterSelectOrganizationUrl`.

    ```diff
    - <OrganizationSwitcher afterSwitchOrganizationUrl="" />
    + <OrganizationSwitcher afterSelectOrganizationUrl="" />
    ```

- The `invitationList` and `membershipList` parameter for the [`useOrganization`](/docs/references/react/use-organization) hook was renamed to `invitations` and `memberships`. In v4 you'd pass in `limit` and `offset`, now you have to use `initialPage` and `pageSize`.

    Before:

    ```js
    const { invitationList, membershipList } = useOrganization({
      invitationList: { limit: 10, offset: 1 },
      membershipList: { limit: 10, offset: 1 },
    })
    ```

    After:

    ```js
    const { invitations, memberships } = useOrganization({
      invitations: { initialPage: 1, pageSize: 10 },
      memberships: { initialPage: 1, pageSize: 10 },
    })
    ```

    For more information, read the [`useOrganization`](/docs/references/react/use-organization) docs.

- The `ClerkProviderOptionsWrapper` type was removed from the exports. Use `ClerkProviderProps` instead.
- Further changes to types:
    - `redirectToUserProfile` now returns `Promise<unknown>` instead of `void`
    - `redirectToOrganizationProfile` now returns `Promise<unknown>` instead of `void`
    - `redirectToCreateOrganization` now returns `Promise<unknown>` instead of `void`
    - `redirectToHome` now returns `Promise<unknown>` instead of `void`

### `@clerk/remix`

- [Rename `apiKey` to `secretKey`](#rename-api-key-to-secret-key)
- [Replace `frontendApi` with `publishableKey`](#replace-frontend-api-with-publishable-key)
- [Rename magic link to email link](#rename-magic-link-to-email-link)
- [Replace `navigate` with `routerPush` & `routerReplace`](#replace-navigate-with-router-push-router-replace)
- [Replace `setSession` with `setActive`](#replace-set-session-with-set-active)
- The `ClerkErrorBoundary` helper has been removed as it's no longer needed.

    ```diff
      import { rootAuthLoader } from "@clerk/remix/ssr.server"
    - import { ClerkApp, ClerkErrorBoundary } from "@clerk/remix"
    + import { ClerkApp } from "@clerk/remix"

      export const loader = (args: DataFunctionArgs) => {
        return rootAuthLoader(args);  
      }

      export default ClerkApp(App)
    - export const ErrorBoundary = ClerkErrorBoundary()
    ```

### `@clerk/clerk-sdk-node`

- [Rename `apiKey` to `secretKey`](#rename-api-key-to-secret-key)
- [Replace `frontendApi` with `publishableKey`](#replace-frontend-api-with-publishable-key)
- Use `@clerk/clerk-sdk-node` as an import, regardless of using CJS or ESM.

    ```diff
    - import { } from "@clerk/clerk-sdk-node/cjs/instance"
    - import { } from "@clerk/clerk-sdk-node/esm/instance"
    + import { } from "@clerk/clerk-sdk-node"
    ```

- Use `createClerkClient` and pass options to it instead of using these removed setters: `setClerkApiVersion`, `setClerkHttpOptions`, `setClerkServerApiUrl`, and `setClerkApiKey`.

    ```diff
    - import { clerkClient, setClerkApiKey } from "@clerk/clerk-sdk-node"
    + import { createClerkClient } from "@clerk/clerk-sdk-node"

    - setClerkApiKey("")
    + const clerkClient = createClerkClient({ secretKey: "" })
      await clerkClient.users.getUser(userId)
    ```

## Community resources

Know a good resource for upgrading from v4 to v5? [Edit this page](https://github.com/clerk/clerk-docs/edit/main/docs/upgrade-guides/upgrading-from-v4-to-v5.mdx) and add a link below!

## Known issues

Please check the [GitHub issues](https://github.com/clerk/javascript/issues) for any reported issues, or file an issue yourself.
