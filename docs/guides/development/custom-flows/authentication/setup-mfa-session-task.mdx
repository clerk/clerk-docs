---
title: Build a custom flow for setting up SMS code based MFA after sign-in
description: Learn how to use the Clerk API to build a custom flow for handling the setup-mfa session task with SMS verification after sign-in.
---

<Include src="_partials/custom-flows-callout" />

When you [require multi-factor authentication (MFA) for all users](/docs/guides/secure/force-mfa), after a new user sign-up or an existing user signing in and if they don't have MFA set up, we will . This guide demonstrates how to build a custom flow to handle this session task using SMS-based MFA.

> [!TIP]
> This guide focuses on SMS-based MFA. For TOTP (authenticator app) MFA, the flow is similar - see the [manage TOTP-based MFA guide](/docs/guides/development/custom-flows/account-updates/manage-totp-based-mfa) for implementation details.

<Steps>
  ## Enable multi-factor authentication requirement

  To require MFA for all users, you need to enable MFA strategies and toggle the MFA requirement in the Clerk Dashboard.

  1. In the Clerk Dashboard, navigate to the [**Multi-factor**](https://dashboard.clerk.com/~/user-authentication/multi-factor) page.
  1. Toggle on **SMS verification code** and **Backup codes**.
  1. Toggle on **Require multi-factor authentication**.
  1. Select **Save**.

  Once enabled, new users and existing users who don't have MFA set up will be prompted to set up MFA.

  ## Build a sign-in flow that redirects to the session task page

  When a user signs in and has a `setup-mfa` session task, you need to redirect them to a page where they can set up MFA. This example shows a basic email/password sign-in that checks for the session task.

  ```tsx {{ filename: 'app/sign-in/page.tsx', collapsible: true }}
  'use client'

  import * as React from 'react'
  import { useSignIn } from '@clerk/nextjs'
  import { useRouter } from 'next/navigation'

  export default function SignInPage() {
    const { signIn, errors, fetchStatus } = useSignIn()
    const router = useRouter()

    const handleSubmit = async (formData: FormData) => {
      const emailAddress = formData.get('email') as string
      const password = formData.get('password') as string

      await signIn.password({
        emailAddress,
        password,
      })

      if (signIn.status === 'complete') {
        await signIn.finalize({
          navigate: async ({ session }) => {
            // Check if the user has a setup-mfa task
            if (session?.currentTask?.key === 'setup-mfa') {
              router.push('/session-tasks/setup-mfa')
              return
            }

            // No tasks, proceed to dashboard
            router.push('/dashboard')
          },
        })
      }
    }

    return (
      <>
        <h1>Sign in</h1>
        <form action={handleSubmit}>
          <div>
            <label htmlFor="email">Email</label>
            <input id="email" name="email" type="email" />
            {errors.fields.emailAddress && <p>{errors.fields.emailAddress.message}</p>}
          </div>
          <div>
            <label htmlFor="password">Password</label>
            <input id="password" name="password" type="password" />
            {errors.fields.password && <p>{errors.fields.password.message}</p>}
          </div>
          <button type="submit" disabled={fetchStatus === 'fetching'}>
            Sign in
          </button>
        </form>
      </>
    )
  }
  ```

  ## Build the MFA setup flow

  This example is written for Next.js App Router but can be adapted for any React-based framework.

  The flow consists of two pages:

  - The main MFA setup page where users can enable a phone number for MFA
  - The add phone number page where users can add and verify a new phone number

  <Include src="_partials/custom-flows/phone-number" />

  Use the following tabs to view the code for each page.

  <Tabs items={["MFA setup page", "Add phone number page"]}>
    <Tab>
      ```tsx {{ filename: 'app/session-tasks/setup-mfa/page.tsx', collapsible: true }}
      'use client'
      import { useUser } from '@clerk/nextjs'
      import { PhoneNumberResource } from '@clerk/nextjs/types'
      import { useRouter } from 'next/navigation'
      import Link from 'next/link'

      // Display phone numbers that can be enabled for MFA
      const AvailablePhoneNumbers = () => {
        const { isSignedIn, user } = useUser()
        const router = useRouter()
        const [backupCodes, setBackupCodes] = React.useState<string[] | undefined>(undefined)

        if (!isSignedIn) {
          return null
        }

        // Get verified phone numbers that aren't reserved for MFA
        const availablePhones = user.phoneNumbers
          .filter((ph) => ph.verification.status === 'verified')
          .filter((ph) => !ph.reservedForSecondFactor)

        // Complete the session task when phone number is picked for MFA
        const completeTask = async () => {
          try {
            await clerk.setActive({
              session: clerk.session?.id,
              navigate: async ({ session }) => {
                router.push('/dashboard')
              },
            })
          } catch (err) {
            // See https://clerk.com/docs/guides/development/custom-flows/error-handling
            // for more info on error handling
            console.error(JSON.stringify(err, null, 2))
          }
        }

        // Enable a phone number for MFA
        const enablePhoneForMfa = async (phone: PhoneNumberResource) => {
          try {
            const reservedPhoneNumber = await phone.setReservedForSecondFactor({ reserved: true })
            setBackupCodes(reservedPhoneNumber.backupCodes || [])
          } catch (err) {
            // See https://clerk.com/docs/guides/development/custom-flows/error-handling
            // for more info on error handling
            console.error(JSON.stringify(err, null, 2))
          }
        }

        if (backupCodes) {
          return (
            <div>
              <p>Backup codes:</p>
              <ul>
                {backupCodes.map((code) => (
                  <li key={code}>{code}</li>
                ))}
              </ul>
              <button onClick={completeTask}>Continue</button>
            </div>
          )
        }

        if (availablePhones.length === 0) {
          return (
            <div>
              <p>No verified phone numbers available.</p>
              <Link href="/session-tasks/setup-mfa/add-phone">
                <button>Add a phone number</button>
              </Link>
            </div>
          )
        }

        return (
          <>
            <h2>Enable a phone number for MFA</h2>
            <ul>
              {availablePhones.map((phone) => (
                <li key={phone.id} style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                  <p>{phone.phoneNumber}</p>
                  <button onClick={() => enablePhoneForMfa(phone)}>Use for MFA</button>
                </li>
              ))}
            </ul>
            <Link href="/session-tasks/setup-mfa/add-phone">
              <button>Add a different phone number</button>
            </Link>
          </>
        )
      }

      export default function SetupMfaPage() {
        const { isLoaded, isSignedIn, user } = useUser()

        if (!isLoaded) {
          return null
        }

        if (!isSignedIn) {
          return <p>You must be signed in to access this page</p>
        }

        // Check if MFA is already enabled
        const hasMfaEnabled = user.twoFactorEnabled

        return (
          <>
            <h1>Set up multi-factor authentication</h1>
            <p>To continue, you need to set up MFA for your account.</p>

            {!hasMfaEnabled && <AvailablePhoneNumbers />}
          </>
        )
      }
      ```
    </Tab>

    <Tab>
      ```tsx {{ filename: 'app/session-tasks/setup-mfa/add-phone/page.tsx', collapsible: true }}
      'use client'

      import * as React from 'react'
      import { useClerk, useUser } from '@clerk/nextjs'
      import { useRouter } from 'next/navigation'

      export default function AddPhonePage() {
        const { isLoaded, isSignedIn, user } = useUser()
        const [phoneNumber, setPhoneNumber] = React.useState('')
        const [code, setCode] = React.useState('')
        const [verifying, setVerifying] = React.useState(false)
        const [backupCodes, setBackupCodes] = React.useState<string[] | undefined>(undefined)
        const [error, setError] = React.useState('')
        const router = useRouter()
        const clerk = useClerk()

        if (!isLoaded) {
          return null
        }

        if (!isSignedIn) {
          return <p>You must be signed in to access this page</p>
        }

        // Add a phone number and send verification code
        const handleAddPhone = async (e: React.FormEvent) => {
          e.preventDefault()
          setError('')

          try {
            const phone = await user.createPhoneNumber({ phoneNumber })
            await phone.prepareVerification()
            setVerifying(true)
          } catch (err: any) {
            // See https://clerk.com/docs/guides/development/custom-flows/error-handling
            // for more info on error handling
            setError(err.errors?.[0]?.longMessage || 'An error occurred')
            console.error(JSON.stringify(err, null, 2))
          }
        }

        const completeTask = async () => {
          try {
            await clerk.setActive({
              session: clerk.session?.id,
              navigate: async ({ session }) => {
                // if there are other remaining session tasks, redirect to the next task
                if (session?.currentTask?.key === 'choose-organization') {
                  router.push('/session-tasks/choose-organization')
                  return
                }

                // if there are no other remaining session tasks, you can redirect to the desired after signed in page
                router.push('/dashboard')
              },
            })
          } catch (err: any) {
            // See https://clerk.com/docs/guides/development/custom-flows/error-handling
            // for more info on error handling
            setError(err.errors?.[0]?.longMessage || 'An error occurred')
            console.error(JSON.stringify(err, null, 2))
          }
        }

        // Verify the phone number with the code
        const handleVerifyPhone = async (e: React.FormEvent) => {
          e.preventDefault()
          setError('')

          try {
            // Find the phone number we just added
            const phoneNumberResource = user.phoneNumbers.find((ph) => ph.phoneNumber === phoneNumber)

            if (!phoneNumberResource) {
              setError('Phone number not found')
              return
            }

            // Verify the phone number
            await phoneNumberResource.attemptVerification({ code })

            // Enable the phone number for MFA
            const reservedPhoneNumber = await phoneNumberResource.setReservedForSecondFactor({
              reserved: true,
            })

            // Set backup codes
            setBackupCodes(reservedPhoneNumber.backupCodes || [])
          } catch (err: any) {
            // See https://clerk.com/docs/guides/development/custom-flows/error-handling
            // for more info on error handling
            setError(err.errors?.[0]?.longMessage || 'An error occurred')
            console.error(JSON.stringify(err, null, 2))
          }
        }

        if (backupCodes && backupCodes.length > 0) {
          return (
            <>
              <h1>Backup codes</h1>
              <p>
                Save these backup codes in a safe place. You can use them to sign in if you lose access to
                your phone.
              </p>
              <ol>
                {backupCodes.map((code, index) => (
                  <li key={index}>{code}</li>
                ))}
              </ol>
              <button onClick={completeTask}>Complete task</button>
            </>
          )
        }

        if (verifying) {
          return (
            <>
              <h1>Verify your phone number</h1>
              <p>Enter the verification code sent to {phoneNumber}</p>
              <form onSubmit={handleVerifyPhone}>
                <div>
                  <label htmlFor="code">Verification code</label>
                  <input
                    id="code"
                    name="code"
                    type="text"
                    value={code}
                    onChange={(e) => setCode(e.target.value)}
                  />
                </div>
                {error && <p style={{ color: 'red' }}>{error}</p>}
                <button type="submit">Verify</button>
              </form>
            </>
          )
        }

        return (
          <>
            <h1>Add a phone number</h1>
            <form onSubmit={handleAddPhone}>
              <div>
                <label htmlFor="phoneNumber">Phone number</label>
                <input
                  id="phoneNumber"
                  name="phoneNumber"
                  type="tel"
                  placeholder="+1 (555) 000-0000"
                  value={phoneNumber}
                  onChange={(e) => setPhoneNumber(e.target.value)}
                />
              </div>
              {error && <p style={{ color: 'red' }}>{error}</p>}
              <button type="submit">Continue</button>
            </form>
          </>
        )
      }
      ```
    </Tab>
  </Tabs>
</Steps>

## Next steps

<Cards>
  - [Session tasks guide](/docs/guides/configure/session-tasks)
  - Learn more about session tasks and how to configure them

  ---

  - [Manage SMS-based MFA](/docs/guides/development/custom-flows/account-updates/manage-sms-based-mfa)
  - Learn how to build a flow for users to manage their MFA settings after sign-in

  ---

  - [Manage TOTP-based MFA](/docs/guides/development/custom-flows/account-updates/manage-totp-based-mfa)
  - Learn how to build a flow for authenticator app (TOTP) MFA
</Cards>
