import { Tab, Tabs } from "nextra-theme-docs";
import { Callout } from "nextra-theme-docs";
import { YouTube } from "@/components/Youtube";
import {Cards} from "@/components/Cards";
import { CodeBlockTabs } from "@/components/CodeBlockTabs";
import { Images } from "@/components/Images";

# Use Clerk with Next.js

Learn how to use Clerk to quickly and easily add secure authentication and user management to your Next.js application. Clerk works seamlessly on both client side and server side components.

By the end of this guide, you will have installed the following user functionality in your application:

- Sign Up
- Sign In
- Protect Pages behind authentication
- Manage Account
- Sign Out


## Install @clerk/nextjs

Once you have a Next.js application ready, you need to install Clerk's Next.js SDK. This gives you access to prebuilt components and hooks, as well as our helpers for Next.js API routes, server-side rendering, and middleware.

<CodeBlockTabs options={['npm', 'yarn', 'pnpm']}>
  ```bash filename="your-project" copy
  npm install @clerk/nextjs
  ```

  ```bash filename="your-project" copy
  yarn add @clerk/nextjs
  ```

  ```bash filename="your-project" copy
  pnpm i @clerk/nextjs
  ```
</CodeBlockTabs>

## Set Environment Keys

Below is an example of an `.env.local` file. To get your keys go to the API Keys page on the [Clerk dashboard](https://dashboard.clerk.com).

```sh copy filename=".env.local"
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_••••••••••••••••••••••••••••••••••
CLERK_SECRET_KEY=sk_test_••••••••••••••••••••••••••••••••••
```

## Mount `<ClerkProvider>`

Update your root layout to include the `<ClerkProvider>` wrapper. The `<ClerkProvider>` component wraps your Next.js application to provide active session and user context to Clerk's hooks and other components. It is recommended that the `<ClerkProvider>` wraps the `<body>` to enable the context to be accessible anywhere within the app.

<Tabs items={["App Router", "Pages"]}>

<Tab>
```tsx copy filename="app/layout.tsx"
import { ClerkProvider } from '@clerk/nextjs'

export const metadata = {
  title: 'Next.js 13 with Clerk',
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <ClerkProvider>
      <html lang="en">
        <body className={inter.className}>{children}</body>
      </html>
    </ClerkProvider>
  )
}

```
</Tab>
<Tab>
```tsx filename="_app.tsx" copy
import { ClerkProvider } from "@clerk/nextjs";
import type { AppProps } from "next/app";
function MyApp({ Component, pageProps }: AppProps) {
  return (
    <ClerkProvider {...pageProps}>
      <Component {...pageProps} />
    </ClerkProvider>
  );
}
export default MyApp;
```
</Tab>
</Tabs>

<Callout type="warning">
  The root layout is a server component, if you plan to use the `<ClerkProvider>` outside the root layout it will need to be a server component as well.
</Callout>

## Protect your application

Now that Clerk is installed and mounted in your application, it’s time to decide which pages are public and which need to hide behind authentication. We do this by creating a `middleware.ts` file at the root folder (or inside `src/` if that is how you set up your app).

```tsx filename="middleware.ts" copy
import { authMiddleware } from "@clerk/nextjs";

// This example protects all routes including api/trpc routes
// Please edit this to allow other routes to be public as needed.
// See https://clerk.com/docs/nextjs/middleware for more information about configuring your middleware
export default authMiddleware({});

export const config = {
  matcher: ["/((?!.*\\..*|_next).*)", "/", "/(api|trpc)(.*)"],
};

```

With this middleware, your entire application is protected. If you try to access it, the middleware will redirect you to your Sign Up page. If you want to make other routes public, check out the [authMiddleware reference page](https://clerk.com/docs/nextjs/middleware).



<Callout type="info" emoji="🎉">

 At this point, your application is fully protected by Clerk and uses Clerk's [Account Portal](/features/account-portal.mdx) pages that are available out of box. Start your Next.js application via `npm run dev`, visit `http://localhost:3000`, and sign up to get access to your application.
</Callout>


## Build your own sign in and sign up pages

In addition to the Account Portal, Clerk also offers a set of prebuilt components that you can use instead to embed sign in, sign up, and other user management functions into your Next.js application. We are going to use the `<SignIn />`, `<SignUp />` components by utilizing the Next.js optional catch all route.



### Build your sign up page


<Tabs items={["App Router", "Pages"]}>
<Tab>
```tsx copy filename="app/sign-up/[[...sign-up]]/page.tsx"
import { SignUp } from "@clerk/nextjs";

export default function Page() {
  return <SignUp />;
}
```
</Tab>
  <Tab>
    ```tsx copy filename="/pages/sign-up/[[...index]].tsx"
import { SignUp } from "@clerk/nextjs";

export default function Page() {
  return <SignUp />;
}
    ```
  </Tab>
</Tabs>

### Build your sign in page


<Tabs items={["App Router", "Pages"]}>
<Tab>
```tsx copy filename="app/sign-in/page.tsx"
import { SignIn } from "@clerk/nextjs";

export default function Page() {
  return <SignIn />;
}
```
</Tab>
  <Tab>
    ```tsx copy filename="/pages/sign-in/[[...index]].tsx"
import { SignIn } from "@clerk/nextjs";

export default function Page() {
  return <SignIn />;
}
    ```
  </Tab>
</Tabs>

<Callout type="info" emoji="ℹ️">
  By default, the Clerk components inherit the font family. With create-next-app they don't apply a global font family. When you launch your application you may notice that the font family is different.
</Callout>


### Update your environment variables 

Next, add environment variables for the `signIn`, `signUp`, `afterSignUp` and `afterSignIn` paths:

```sh copy filename=".env.local"
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/
    ```

These values control the behavior of the components when you sign in or sign up and when you click on the respective links at the bottom of each component.

## Embed the <UserButton /> 

The `<UserButton />` allows users to manage their account information and log out, thus allowing you to complete a full authentication circle.

You can add it anywhere you want, but next to the logo in in your main application page is a good start.

<Tabs items={["App Router", "Pages"]}>
<Tab>
```tsx copy filename="app/page.tsx"
import { UserButton } from "@clerk/nextjs";

export default function Home() {
  return (
    <div>
      <UserButton afterSignOutUrl="/"/>
    </div>
  )
}
```
</Tab>
  <Tab>
    ```tsx copy filename="pages/example.tsx"
import { UserButton } from "@clerk/nextjs";
 
export default function Example() {
  return (
    <>
			<header>
				<UserButton afterSignOutUrl="/"/>
			</header>
			<div>Your page's content can go here.</div>
    </>
  );
}
    ```
  </Tab>
</Tabs>

## Sign up for your Application

Now start your Next.js application via `npm run dev` , visit `http://localhost:3000`, and sign up to get access to your application.



## Read Session & User Data

Clerk provides a set of hooks and helpers that you can use to access the active session and user data in your Next.js application. We have included examples of how to use these helpers in both the client and server side to get you started.

### Client Side

#### `useAuth`

The `useAuth` hook is a convenient way to access the current auth state. This hook provides the minimal information needed for data-loading and helper methods to manage the current active session.

```tsx copy filename="example.tsx"
"use client";
import { useAuth } from "@clerk/nextjs";

export default function Example() {
  const { isLoaded, userId, sessionId, getToken } = useAuth();

  // In case the user signs out while on the page.
  if (!isLoaded || !userId) {
    return null;
  }

  return (
    <div>
      Hello, {userId} your current active session is {sessionId}
    </div>
  );
}
```

#### `useUser`

The `useUser` hook is a convenient way to access the current user data where you need it. This hook provides the user data and helper methods to manage the current active session.

```tsx copy filename="example.tsx"
"use client";
import { useUser } from "@clerk/nextjs";

export default function Example() {
  const { isLoaded, isSignedIn, user } = useUser();

  if (!isLoaded || !isSignedIn) {
    return null;
  }

  return <div>Hello, {user.firstName} welcome to Clerk</div>;
}
```

### Server Side

#### API Routes

You can protect your API routes by using the `getAuth` helper and retrieve data from your own systems.

```tsx copy filename="pages/api/auth.ts"
import type { NextApiRequest, NextApiResponse } from "next";
import { getAuth } from "@clerk/nextjs/server";

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  const { userId } = getAuth(req);
  if (!userId) {
    res.status(401).json({ error: "Unauthorized" });
    return;
  }
  // retrieve data from your database
  res.status(200).json({});
}
```

In some cases you may need the full user object, for example, if you want to access the user's email address or name. You can use the `clerkClient` helper to get the full user object.

```tsx copy filename="pages/api/auth.ts"
import { getAuth, clerkClient } from "@clerk/nextjs/server";
import type { NextApiRequest, NextApiResponse } from "next";

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const { userId } = getAuth(req);

  if (!userId) {
    return res.status(401).json({ error: "Unauthorized" });
  }

  const user = userId ? await clerkClient.users.getUser(userId) : null;

  // use the user object to decide what data to return

  return res.status(200).json({});
}
```

### Server Side Render User Data

<Tabs items={["App Directory", "Pages Directory"]}>
<Tab>
  #### **`currentUser()`**

Current user loads the User object for the authenticated user from Clerk's backend API. This is helpful if you want to render information like their first and last name directly from the server.

Under the hood, this calls `fetch()` so it is automatically deduped per request.

```tsx copy filename="page.tsx"
import { currentUser } from "@clerk/nextjs/app-beta";
import type { User } from "@clerk/nextjs/api";

export default async function Page() {
  const user: User | null = await currentUser();
  // ...
}
```

#### **`auth()`**

We have introduced a new `auth()` helper that returns the same Authentication Object as `getAuth(req)` in middleware, getServerSideProps, and API routes.

Since request data like `headers()` and `cookies()` is now available in the global scope for Next.js, you no longer need to explicitly pass a Request object to Clerk

```tsx copy filename="app/page.tsx"
import { auth } from '@clerk/nextjs/app-beta';

export default function Page() {
  const { userId } : { userId: string | null } = auth();
  // ...
}
```
</Tab>
  <Tab>

You can access the active session and user data in your `getServerSideProps` using the `getAuth` helper.

<Callout type="info" emoji="ℹ️">
Please note the addition of buildClerkProps in the return statement, which informs our React helpers of the authentication state during server-side rendering (like `useAuth()`, `<SignedIn>`, and `<SignedOut>`).
</Callout>

```tsx copy filename="pages/example.tsx"
import { getAuth, buildClerkProps } from "@clerk/nextjs/server";
import { GetServerSideProps } from "next";

export const getServerSideProps: GetServerSideProps = async (ctx) => {
  const { userId } = getAuth(ctx.req);

  if (!userId) {
    // handle user is not logged in.
  }

  // Load any data your application needs for the page using the userId
  return { props: { ...buildClerkProps(ctx.req) } };
};
```

You can also access the full user object before passing it to the page using the `clerkClient` helper.

```tsx copy filename="pages/example.tsx"
import { clerkClient, getAuth, buildClerkProps } from "@clerk/nextjs/server";
import { GetServerSideProps } from "next";

export const getServerSideProps: GetServerSideProps = async (ctx) => {
  const { userId } = getAuth(ctx.req);

  const user = userId ? await clerkClient.users.getUser(userId) : undefined;

  return { props: { ...buildClerkProps(ctx.req, { user }) } };
};
```
  </Tab>
</Tabs>

## Next Steps

Now you have an application integrated with Clerk you will want to read the following documentation:

<div className="container mx-auto my-4">
  <div className="grid grid-cols-1 gap-6 md:grid-cols-2">
    <Cards
      title="Customization & Localization"
      description="Learn how to customize and localize the Clerk components."
      link="/reference-react/customization/appearance"
      cta="Learn More"
    />
    <Cards
      title="Server Side Helpers"
      description="Learn more about our server side helpers and how to use them."
      link="/reference-next/get-auth"
      cta="Learn More"
    />
    <Cards
      title="Client Side Helpers"
      description="Learn more about our client side helpers and how to use them."
      link="/reference-react/user-management/use-auth"
      cta="Learn More"
    />
  </div>
</div>
